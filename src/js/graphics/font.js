var defs = {
    'a': [
        [1,1,1],
        [1,0,1],
        [1,1,1],
        [1,0,1],
        [1,0,1]
    ],
    'b': [
        [1,1,1],
        [1,0,1],
        [1,1,0],
        [1,0,1],
        [1,1,1]
    ],
    'c': [
        [1,1,1],
        [1,0,0],
        [1,0,0],
        [1,0,0],
        [1,1,1]
    ],
    'd': [
        [1,1,0],
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,1,1]
    ],
    'e': [
        [1,1,1],
        [1,0,0],
        [1,1,0],
        [1,0,0],
        [1,1,1]
    ],
    'f': [
        [1,1,1],
        [1,0,0],
        [1,1,0],
        [1,0,0],
        [1,0,0]
    ],
    'g': [
        [1,1,1],
        [1,0,0],
        [1,0,0],
        [1,0,1],
        [1,1,1]
    ],
    'h': [
        [1,0,1],
        [1,0,1],
        [1,1,1],
        [1,0,1],
        [1,0,1]
    ],
    'i': [
        [1,1,1],
        [0,1,0],
        [0,1,0],
        [0,1,0],
        [1,1,1]
    ],
    'j': [
        [0,0,1],
        [0,0,1],
        [0,0,1],
        [1,0,1],
        [1,1,1]
    ],
    'k': [
        [1,0,1],
        [1,0,1],
        [1,1,0],
        [1,0,1],
        [1,0,1]
    ],
    'l': [
        [1,0,0],
        [1,0,0],
        [1,0,0],
        [1,0,0],
        [1,1,1]
    ],
    'm': [
        [1,0,1],
        [1,1,1],
        [1,0,1],
        [1,0,1],
        [1,0,1]
    ],
    'n': [
        [1,1,1],
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,0,1]
    ],
    'o': [
        [1,1,1],
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,1,1]
    ],
    'p': [
        [1,1,1],
        [1,0,1],
        [1,1,1],
        [1,0,0],
        [1,0,0]
    ],
    'q': [
        [1,1,1],
        [1,0,1],
        [1,0,1],
        [1,1,1],
        [0,0,1]
    ],
    'r': [
        [1,1,1],
        [1,0,1],
        [1,1,0],
        [1,0,1],
        [1,0,1]
    ],
    's': [
        [1,1,1],
        [1,0,0],
        [1,1,1],
        [0,0,1],
        [1,1,1]
    ],
    't': [
        [1,1,1],
        [0,1,0],
        [0,1,0],
        [0,1,0],
        [0,1,0]
    ],
    'u': [
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,1,1]
    ],
    'v': [
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [0,1,0]
    ],
    'w': [
        [1,0,1,0,1],
        [1,0,1,0,1],
        [1,0,1,0,1],
        [1,0,1,0,1],
        [0,1,0,1,0]
    ],
    'x': [
        [1,0,1],
        [1,0,1],
        [0,1,0],
        [1,0,1],
        [1,0,1]
    ],
    'y': [
        [1,0,1],
        [1,0,1],
        [1,1,1],
        [0,1,0],
        [0,1,0]
    ],
    /*'\'': [
        [1]
    ],*/
    '.': [
        [0],
        [0],
        [0],
        [0],
        [1]
    ],
    ' ': [
        [0,0],
        [0,0],
        [0,0],
        [0,0],
        [0,0]
    ],
    '-': [
        [0,0],
        [0,0],
        [1,1],
        [0,0],
        [0,0]
    ],
    ':': [
        [0],
        [1],
        [ ],
        [1],
        [ ]
    ],
    '?': [
        [1,1,1],
        [1,1,1],
        [1,1,1],
        [1,1,1],
        [1,1,1]
    ],
    '!': [
        [0,1,0,1,0],
        [1,1,1,1,1],
        [1,1,1,1,1],
        [0,1,1,1,0],
        [0,0,1,0,0]
    ],
    '/': [
        [0,0,1],
        [0,0,1],
        [0,1,0],
        [1,0,0],
        [1,0,0]
    ],
    '1': [
        [1,1,0],
        [0,1,0],
        [0,1,0],
        [0,1,0],
        [1,1,1]
    ],
    '2': [
        [1,1,1],
        [0,0,1],
        [1,1,1],
        [1,0,0],
        [1,1,1]
    ],
    '3': [
        [1,1,1],
        [0,0,1],
        [0,1,1],
        [0,0,1],
        [1,1,1]
    ],
    '4': [
        [1,0,0],
        [1,0,0],
        [1,0,1],
        [1,1,1],
        [0,0,1]
    ],
    '5': [
        [1,1,1],
        [1,0,0],
        [1,1,0],
        [0,0,1],
        [1,1,0]
    ],
    '6': [
        [1,1,1],
        [1,0,0],
        [1,1,1],
        [1,0,1],
        [1,1,1]
    ],
    '7': [
        [1,1,1],
        [0,0,1],
        [0,1,0],
        [0,1,0],
        [0,1,0]
    ],
    '8': [
        [1,1,1],
        [1,0,1],
        [1,1,1],
        [1,0,1],
        [1,1,1]
    ],
    '9': [
        [1,1,1],
        [1,0,1],
        [1,1,1],
        [0,0,1],
        [1,1,1]
    ],
    '0': [
        [1,1,1],
        [1,0,1],
        [1,0,1],
        [1,0,1],
        [1,1,1]
    ],
    '(': [
        [0,1],
        [1],
        [1],
        [1],
        [0,1]
    ],
    ')': [
        [1],
        [0,1],
        [0,1],
        [0,1],
        [1]
    ],
    '[': [
        [1,1],
        [1],
        [1],
        [1],
        [1,1]
    ],
    ']': [
        [1,1],
        [0,1],
        [0,1],
        [0,1],
        [1,1]
    ],
    '': [
        [1, 0],
        [0, 1],
        [0, 1],
        [0, 1],
        [1]
    ],
    '#': [
        [0, 1, 0, 1, 0],
        [1, 1, 1, 1, 1],
        [0, 1, 0, 1, 0],
        [1, 1, 1, 1, 1],
        [0, 1, 0, 1, 0]
    ],
    '+': [
        [0, 0, 1, 0, 0],
        [0, 0, 1, 0, 0],
        [1, 1, 1, 1, 1],
        [0, 0, 1, 0, 0],
        [0, 0, 1, 0, 0]
    ]
};

Object.keys(defs).forEach(key => defs[key.toLocaleUpperCase()] = defs[key] )


if(DEBUG){
    (function() {
        window.used = {};
        for(var i in defs){
            window.used[i] = false;
        }

        window.checkUsed = function(){
            var unused = [];
            for (let i in window.used) {
                if(!window.used[i]){
                    unused.push(i);
                }
            }
            return unused.sort();
        };
    })();
}

// r: context
// t: text
// x: x coord
// y: y coord
// s: shadow offset
// c: color
// sh: render shadow
function drawText(text, x, y, shadowOffset, color, sh) {
    if (sh) {
        drawText(text, x, y + shadowOffset , shadowOffset, '#000');
    }

    for(var i = 0 ; i < text.length ; i++){
        if (DEBUG) {
            window.used[text.charAt(i)] = true;
        }

        const cached = cachedCharacter(text.charAt(i), shadowOffset, color);
        R.drawImage(cached, x, y);
        x += cached.width + shadowOffset;
    }
}

function drawCenteredText(t, x, y, s, c, sh) {
    return drawText(t, x - s * requiredCells(t) / 2, y, s, c, sh);
}

// Returns the total cells required to draw the specified text
function requiredCells(t) {
    t = t || '';

    let r = 0;
    for(var i = 0 ; i < t.length ; i++) {
        let charDef = defs[t.charAt(i)];
        if(!charDef) { charDef = defs[''] }
        r += charDef[0].length + 1;
    }
    return r - 1;
}

const cachedChars = new Map();

// Optimized by using for () loop instead of .forEach()
function cachedCharacter(t, s, c){
    let key = t + s + c;
    let charDef = defs[t];
    if(!charDef) { charDef = defs[''] }
    let constChar = cachedChars.get(key);
    if(constChar){ return constChar }

     constChar = cache(charDef[0].length * s, charDef.length * s, function(r) {
        r.fillStyle = c;
       let row,col, y, x;
       for (row = 0; row < charDef.length; row++) {
         y = charDef[row];
         for (col = 0 ; col < y.length; col++) {
            x = y[col];
            if(x) { r.fr(col * s, row * s, s, s);  }
         }
       }
    });
    cachedChars.set(key, constChar);
    return constChar
}
